<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at 10% 0%, #10161f 0%, #06090f 55%, #04060b 100%);
            --glass: rgba(255, 255, 255, 0.06);
            --card-bg: linear-gradient(150deg, rgba(26, 31, 45, 0.9) 0%, rgba(16, 20, 30, 0.92) 100%);
            --card-border: rgba(147, 167, 255, 0.12);
            --card-highlight: rgba(120, 155, 255, 0.18);
            --card-shadow: 0 24px 60px rgba(8, 12, 28, 0.4);
            --accent: #ffc15a;
            --accent-strong: #ff9f3c;
            --accent-soft: rgba(255, 193, 90, 0.15);
            --accent-contrast: #1b1f2b;
            --focus-ring: rgba(90, 200, 250, 0.28);
            --text-primary: #f8f9ff;
            --text-secondary: rgba(238, 241, 255, 0.75);
            --text-muted: rgba(238, 241, 255, 0.44);
            --frost: rgba(255, 255, 255, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            padding: 24px 18px 48px;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(102, 136, 255, 0.18), transparent 62%),
                        radial-gradient(circle at bottom left, rgba(255, 158, 82, 0.12), transparent 60%);
            pointer-events: none;
            z-index: -1;
        }

        .app-shell {
            max-width: 520px;
            margin: 0 auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .brand-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .brand-sub {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .refresh-btn {
            border: 1px solid rgba(147, 167, 255, 0.14);
            border-radius: 18px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(24, 29, 42, 0.65);
            backdrop-filter: blur(14px);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.18s ease, box-shadow 0.18s ease, color 0.18s ease;
            box-shadow: 0 6px 18px rgba(16, 22, 38, 0.28);
        }

        .refresh-btn:active {
            transform: translateY(1px);
            box-shadow: 0 3px 12px rgba(12, 18, 34, 0.32);
        }

        .refresh-btn:hover {
            color: var(--text-primary);
            box-shadow: 0 12px 24px rgba(18, 24, 42, 0.35);
        }

        .hero-card {
            position: relative;
            padding: 26px;
            border-radius: 28px;
            background: linear-gradient(140deg, rgba(28, 33, 48, 0.92) 0%, rgba(20, 23, 35, 0.9) 100%);
            border: 1px solid rgba(147, 167, 255, 0.18);
            box-shadow: 0 30px 80px rgba(12, 18, 42, 0.38);
            overflow: hidden;
        }

        .hero-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 184, 92, 0.28), transparent 58%),
                        radial-gradient(circle at bottom left, rgba(85, 144, 255, 0.22), transparent 65%);
            pointer-events: none;
        }

        .hero-header {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .hero-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .hero-title {
            font-size: 27px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .hero-caption {
            margin-top: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .sort-toggle {
            display: inline-flex;
            border-radius: 18px;
            border: 1px solid rgba(147, 167, 255, 0.16);
            background: rgba(8, 12, 22, 0.65);
            overflow: hidden;
            backdrop-filter: blur(14px);
        }

        .sort-toggle button {
            padding: 9px 18px;
            font-size: 13px;
            font-weight: 600;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        .sort-toggle button.active {
            background: linear-gradient(120deg, rgba(255, 193, 90, 0.28), rgba(90, 200, 250, 0.24));
            color: var(--text-primary);
            box-shadow: inset 0 0 0 1px rgba(255, 193, 90, 0.12);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .metric-card {
            padding: 16px;
            border-radius: 18px;
            background: rgba(19, 23, 35, 0.82);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

            .metric-card {
                padding: 18px;
                border-radius: 20px;
                background: rgba(18, 22, 34, 0.82);
                border: 1px solid rgba(147, 167, 255, 0.14);
                box-shadow: 0 18px 36px rgba(10, 16, 32, 0.38);
                position: relative;
                overflow: hidden;
            margin-bottom: 6px;

            .metric-card::after {
                content: "";
                position: absolute;
                inset: 0;
                background: radial-gradient(circle at top left, rgba(90, 200, 250, 0.22), transparent 62%);
                pointer-events: none;
            }
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
        }

        .orders-section {
            margin-top: 28px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .orders-section-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: var(--text-secondary);
            letter-spacing: 0.4px;
            font-weight: 600;
            transform-origin: left center;
            transition: color 0.3s ease;
        }

        .orders-section-title__flame {
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 4px 12px rgba(255, 159, 60, 0.45));
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        .orders-section-title__text {
            display: inline-flex;
            align-items: center;
        }

        .orders-section-title--pulse {
            animation: ordersTitlePulse 4s ease-in-out;
            color: var(--text-primary);
        }

        .orders-section-title__flame--active {
            animation: flameFlicker 0.9s ease-in-out 0s 5;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .order-card {
            position: relative;
            padding: 24px;
            border-radius: 26px;
            background: var(--card-bg);
            border: 1px solid rgba(147, 167, 255, 0.14);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.22s ease, box-shadow 0.22s ease, border-color 0.22s ease;
        }

        .order-card::before {
            content: "";
            position: absolute;
            top: -32%;
            right: -18%;
            height: 140%;
            width: 140%;
            background: radial-gradient(260px circle at 75% 25%, rgba(255, 193, 90, 0.22) 0%, rgba(255, 193, 90, 0.08) 55%, transparent 82%);
            opacity: 0.6;
            pointer-events: none;
        }

        .order-card::after {
            content: "";
            position: absolute;
            inset: auto 8% -42% -40%;
            height: 60%;
            width: 55%;
            background: radial-gradient(circle at center, rgba(90, 200, 250, 0.18), transparent 74%);
            pointer-events: none;
        }

        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 30px 80px rgba(12, 18, 40, 0.45);
            border-color: rgba(147, 167, 255, 0.32);
        }

        .order-card__head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .order-id {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .order-price {
            text-align: right;
        }

        .price-amount {
            font-size: 27px;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: 0.2px;
            text-shadow: 0 6px 18px rgba(255, 159, 60, 0.35);
        }

        .price-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .order-title {
            font-size: 19px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .order-fields {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-field {
            padding: 14px 16px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(20, 24, 36, 0.78) 0%, rgba(16, 20, 30, 0.9) 100%);
            border: 1px solid rgba(147, 167, 255, 0.12);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
            word-break: break-word;
            overflow-wrap: anywhere;
            position: relative;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .order-field--address {
            padding: 13px 16px;
        }

        .order-field--description {
            padding: 18px 18px 20px;
        }

        .order-field::after {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255, 193, 90, 0.08), rgba(90, 200, 250, 0.06));
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .order-field:hover::after {
            opacity: 0.55;
        }

        .order-field__label {
            font-size: 12px;
            letter-spacing: 0.55px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .order-field__value {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .order-field--address .order-field__value {
            white-space: normal;
            line-height: 1.5;
            font-weight: 600;
        }

        .order-field__inline {
            display: inline;
        }

        .order-field__time {
            font-weight: 700;
            color: var(--accent);
            margin-left: 8px;
            white-space: nowrap;
        }

        .order-field__note {
            margin-top: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .order-field--description .order-field__value {
            position: relative;
        }

        .order-field__value--collapsible {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            white-space: normal;
            transition: max-height 0.28s ease;
        }

        .order-field__value--collapsible:not(.is-collapsible) {
            cursor: default;
        }

        .order-field__value--collapsible .order-field__inner {
            white-space: pre-line;
            line-height: 1.6;
            position: relative;
        }

        .order-field__value--collapsible .order-field__fade {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 48px;
            background: linear-gradient(180deg, rgba(16, 20, 30, 0) 0%, rgba(16, 20, 30, 0.92) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .order-field__value--collapsible.is-collapsible:not(.is-expanded) .order-field__fade {
            opacity: 1;
        }

        .order-field__value--collapsible::after {
            content: '';
            position: absolute;
            right: 16px;
            bottom: 14px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: var(--accent);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .order-field__value--collapsible.is-collapsible::after {
            content: '—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
            opacity: 0.85;
        }

        .order-field__value--collapsible.is-expanded::after {
            content: '—Å–≤–µ—Ä–Ω—É—Ç—å';
        }

        .order-field__value--collapsible.is-expanded .order-field__fade {
            opacity: 0;
        }

        .order-field__value--collapsible.is-collapsible:not(.is-expanded) .order-field__inner::after {
            content: '‚Ä¶';
            position: absolute;
            bottom: 0;
            right: 0;
            padding-left: 6px;
            background: linear-gradient(90deg, rgba(16, 20, 30, 0), rgba(16, 20, 30, 0.92));
        }

        .order-stats {
            margin-top: 18px;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 12px;
        }

        .order-stats__item {
            padding: 12px 16px;
            border-radius: 14px;
            background: rgba(18, 22, 34, 0.68);
            border: 1px solid rgba(147, 167, 255, 0.12);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .order-stats__label {
            font-size: 11px;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
            display: block;
        }

        .order-stats__value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .order-stats__rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--accent);
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 18px;
        }

        .chip {
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(24, 29, 42, 0.7);
            border: 1px solid rgba(147, 167, 255, 0.12);
            backdrop-filter: blur(12px);
        }

        .chip.accent {
            background: linear-gradient(120deg, rgba(255, 193, 90, 0.25), rgba(90, 200, 250, 0.2));
            color: var(--accent);
            border-color: rgba(255, 193, 90, 0.45);
            box-shadow: 0 10px 24px rgba(255, 193, 90, 0.25);
        }

        .order-footer {
            margin-top: 22px;
        }

        .swipe-actions {
            position: relative;
            display: flex;
            align-items: stretch;
            border-radius: 18px;
            overflow: hidden;
            background: rgba(18, 22, 34, 0.78);
            border: 1px solid rgba(147, 167, 255, 0.14);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .primary-btn {
            position: relative;
            width: 100%;
            border: none;
            padding: 16px 18px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.4px;
            cursor: pointer;
            color: var(--accent-contrast);
            background: linear-gradient(125deg, var(--accent), var(--accent-strong));
            box-shadow: 0 20px 38px rgba(255, 159, 60, 0.32);
            transition: transform 0.2s ease, box-shadow 0.18s ease, filter 0.18s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            will-change: transform;
            touch-action: pan-y;
        }

        .primary-btn.swipe-active {
            transition: none;
        }

        .primary-btn:active {
            transform: translateY(1px);
            box-shadow: 0 12px 24px rgba(255, 159, 60, 0.26);
            filter: brightness(1.02);
        }

        .primary-btn__label {
            pointer-events: none;
        }

        .primary-btn__hint {
            pointer-events: none;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.32);
            color: rgba(27, 31, 43, 0.75);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .swipe-actions.revealed .primary-btn__hint {
            opacity: 0;
            transform: translateX(-12px);
        }

        .complain-btn {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            min-width: 150px;
            border: none;
            border-radius: 0;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.4px;
            background: linear-gradient(135deg, rgba(255, 103, 128, 0.95), rgba(255, 140, 105, 0.9));
            color: #2a0610;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
            cursor: pointer;
        }

        .complain-btn span {
            pointer-events: none;
        }

        .state-placeholder {
            padding: 40px 18px;
            text-align: center;
            color: var(--text-secondary);
            border-radius: 20px;
            border: 1px dashed rgba(147, 167, 255, 0.18);
            background: rgba(16, 20, 32, 0.7);
        }

        .state-placeholder h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .state-placeholder p {
            font-size: 14px;
            line-height: 1.5;
        }

        .skeleton-card {
            position: relative;
            padding: 22px;
            border-radius: 24px;
            background: rgba(19, 23, 35, 0.75);
            overflow: hidden;
        }

        .skeleton-block {
            height: 14px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
            position: relative;
        }

        .skeleton-block::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.18) 45%, transparent 100%);
            animation: shimmer 1.4s infinite;
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .confirm-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 24px 16px 36px;
            background: rgba(8, 12, 24, 0.72);
            backdrop-filter: blur(6px);
            z-index: 30;
        }

        .confirm-overlay.visible {
            display: flex;
        }

        .confirm-card {
            width: 100%;
            max-width: 520px;
            border-radius: 26px;
            padding: 24px;
            background: rgba(18, 20, 32, 0.95);
            border: 1px solid rgba(147, 167, 255, 0.2);
            box-shadow: 0 30px 60px rgba(8, 12, 32, 0.35);
            transform: translateY(14px);
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .confirm-overlay.visible .confirm-card {
            transform: translateY(0);
            opacity: 1;
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .confirm-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 22px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .confirm-btn.confirm {
            background: linear-gradient(120deg, var(--accent), var(--accent-strong));
            color: #0d1220;
        }

        .report-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 24px 16px 36px;
            background: rgba(8, 12, 24, 0.8);
            backdrop-filter: blur(6px);
            z-index: 35;
        }

        .report-overlay.visible {
            display: flex;
        }

        .report-card {
            width: 100%;
            max-width: 520px;
            background: rgba(18, 20, 32, 0.96);
            border: 1px solid rgba(147, 167, 255, 0.22);
            border-radius: 26px;
            padding: 24px;
            box-shadow: 0 30px 60px rgba(8, 12, 32, 0.4);
            transform: translateY(16px);
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .report-overlay.visible .report-card {
            transform: translateY(0);
            opacity: 1;
        }

        .report-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .report-title {
            font-size: 18px;
            font-weight: 700;
        }

        .report-order {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .report-label {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 8px;
            display: block;
        }

        .report-textarea {
            width: 100%;
            min-height: 120px;
            border-radius: 18px;
            padding: 14px 16px;
            border: 1px solid rgba(147, 167, 255, 0.16);
            background: rgba(12, 16, 26, 0.92);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }

        .report-textarea::placeholder {
            color: var(--text-muted);
        }

        .report-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .report-btn {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .report-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .report-btn.primary {
            background: linear-gradient(120deg, rgba(255, 103, 128, 0.95), rgba(255, 140, 105, 0.9));
            color: #2a0610;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translate(-50%, 24px);
            padding: 14px 20px;
            border-radius: 16px;
            background: rgba(20, 24, 36, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.2px;
            box-shadow: 0 12px 30px rgba(8, 12, 32, 0.38);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            backdrop-filter: blur(12px);
            z-index: 40;
        }

        .toast.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        .toast.toast--success {
            background: rgba(66, 214, 151, 0.88);
            color: #052318;
            border: none;
        }

        .toast.toast--error {
            background: rgba(255, 95, 109, 0.92);
            color: #320205;
            border: none;
        }

        @keyframes ordersTitlePulse {
            0% {
                transform: scale(1);
                letter-spacing: 0.4px;
                text-shadow: none;
            }
            15% {
                transform: scale(1.06);
                letter-spacing: 0.8px;
                text-shadow: 0 0 16px rgba(255, 193, 90, 0.25);
            }
            35% {
                transform: scale(1.1);
                letter-spacing: 1px;
                text-shadow: 0 0 24px rgba(255, 159, 60, 0.32);
            }
            65% {
                transform: scale(1.04);
                letter-spacing: 0.7px;
                text-shadow: 0 0 14px rgba(255, 193, 90, 0.18);
            }
            100% {
                transform: scale(1);
                letter-spacing: 0.4px;
                text-shadow: none;
            }
        }

        @keyframes flameFlicker {
            0% {
                transform: scale(1) rotate(0deg) translateY(0);
                filter: drop-shadow(0 4px 12px rgba(255, 159, 60, 0.4));
            }
            20% {
                transform: scale(0.96) rotate(-3deg) translateY(1px);
                filter: drop-shadow(0 6px 16px rgba(255, 200, 120, 0.52));
            }
            40% {
                transform: scale(1.08) rotate(2deg) translateY(-1px);
                filter: drop-shadow(0 7px 18px rgba(255, 130, 66, 0.6));
            }
            60% {
                transform: scale(0.98) rotate(-1deg);
                filter: drop-shadow(0 4px 12px rgba(255, 180, 90, 0.4));
            }
            80% {
                transform: scale(1.05) rotate(3deg) translateY(-2px);
                filter: drop-shadow(0 8px 22px rgba(255, 120, 60, 0.58));
            }
            100% {
                transform: scale(1) rotate(0deg) translateY(0);
                filter: drop-shadow(0 4px 12px rgba(255, 159, 60, 0.45));
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @media (max-width: 520px) {
            body {
                padding: 18px 12px 32px;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .hero-card {
                padding: 18px;
                border-radius: 22px;
            }

            .hero-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 18px;
            }

            .sort-toggle {
                width: 100%;
            }

            .sort-toggle button {
                flex: 1;
                padding: 10px 0;
                text-align: center;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .order-card {
                padding: 18px;
                border-radius: 20px;
            }

            .order-card__head {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .order-price {
                width: 100%;
                text-align: left;
                display: flex;
                align-items: baseline;
                justify-content: space-between;
                gap: 12px;
            }

            .price-amount {
                font-size: 22px;
            }

            .order-fields {
                gap: 10px;
            }

            .order-field {
                padding: 12px 14px;
            }

            .order-field--address {
                padding: 11px 14px;
            }

            .order-field--description {
                padding: 16px 16px 18px;
            }

            .order-field__label {
                font-size: 11px;
            }

            .order-field__value {
                font-size: 14px;
                line-height: 1.45;
            }

            .order-field__time {
                font-size: 12px;
            }

            .order-field__note {
                font-size: 12px;
            }

            .chip-row {
                gap: 6px;
                margin-top: 16px;
            }

            .chip {
                font-size: 11px;
                padding: 6px 10px;
            }

            .primary-btn {
                padding: 14px;
                font-size: 15px;
            }
        }

        @media (max-width: 360px) {
            body {
                padding: 20px 14px 34px;
            }

            .hero-header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .price-amount {
                font-size: 20px;
            }

            .primary-btn {
                font-size: 15px;
                padding: 15px 16px;
            }

            .primary-btn__hint {
                font-size: 10px;
                letter-spacing: 0.8px;
            }

            .complain-btn {
                min-width: 132px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="top-bar">
            <div>
                <div class="brand-title">–ë–µ—Ä—É–ó–∞–∫–∞–∑ ‚Äî –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</div>
                <div class="brand-sub">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–º–µ–Ω—ã –ø–æ–¥ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="loadOrders(true)">
                <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
            </button>
        </div>

        <section class="hero-card">
            <div class="hero-header">
                <div class="hero-header-top">
                    <div>
                        <div class="hero-title">‚ö° –õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</div>
                        <p class="hero-caption">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –±—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫ –≤ –æ–¥–∏–Ω —Ç–∞–ø</p>
                    </div>
                    <div class="sort-toggle">
                        <button id="sortCheap" class="active" onclick="setSort('asc')">–î–µ—à–µ–≤–ª–µ</button>
                        <button id="sortExpensive" onclick="setSort('desc')">–î–æ—Ä–æ–∂–µ</button>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">–°–≤–æ–±–æ–¥–Ω—ã—Ö —Å–º–µ–Ω</div>
                        <div class="metric-value" id="metricAvailable">‚Äî</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                        <div class="metric-value" id="metricAvg">‚Äî ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="orders-section">
            <div class="orders-section-title">
                <span class="orders-section-title__flame" aria-hidden="true">üî•</span>
                <span class="orders-section-title__text">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</span>
            </div>
            <div id="ordersContainer" class="orders-list"></div>
        </section>
    </div>

    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-card">
            <div class="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–∫–ª–∏–∫</div>
            <div class="confirm-text" id="confirmText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è?</div>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" onclick="hideConfirm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn confirm" onclick="confirmAccept()">–î–∞, –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <div class="report-overlay" id="complaintOverlay">
        <div class="report-card">
            <div class="report-header">
                <div class="report-title">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</div>
                <div class="report-order" id="complaintOrderInfo">–ó–∞–∫–∞–∑ #‚Äî</div>
            </div>
            <label class="report-label" for="complaintTextarea">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã</label>
            <textarea class="report-textarea" id="complaintTextarea" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω–µ —Ç–∞–∫ —Å —ç—Ç–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º"></textarea>
            <div class="report-actions">
                <button class="report-btn secondary" type="button" onclick="hideComplaint()">–û—Ç–º–µ–Ω–∞</button>
                <button class="report-btn primary" type="button" onclick="submitComplaint()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
        const tg = window.Telegram?.WebApp;
        tg?.expand?.();

        const userId = tg?.initDataUnsafe?.user?.id;
        const ordersContainer = document.getElementById('ordersContainer');
        const metricAvailable = document.getElementById('metricAvailable');
        const metricAvg = document.getElementById('metricAvg');
        const toastEl = document.getElementById('toast');
        const confirmOverlay = document.getElementById('confirmOverlay');
        const complaintOverlay = document.getElementById('complaintOverlay');
        const complaintOrderInfo = document.getElementById('complaintOrderInfo');
        const complaintTextarea = document.getElementById('complaintTextarea');
        const highlightTitle = document.querySelector('.orders-section-title');
        const highlightFlame = highlightTitle?.querySelector('.orders-section-title__flame');
        const refreshBtn = document.getElementById('refreshBtn');
        const COLLAPSIBLE_COLLAPSED_HEIGHT = 118;
        let complaintOrderId = null;

        let ordersCache = [];
        let sortDirection = 'asc';
        let pendingOrderId = null;
        let toastTimer = null;
        let activeSwipe = null;
        let isSubmittingComplaint = false;
        let collapsibleResizeTimer = null;
        let highlightPlayed = false;
        let highlightTimer = null;

        function showToast(message, type = 'info') {
            if (!toastEl) return;
            toastEl.textContent = message;
            toastEl.className = `toast toast--${type}`;
            // Force reflow to restart animation when same toast reappears quickly
            void toastEl.offsetWidth;
            toastEl.classList.add('visible');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toastEl.classList.remove('visible');
            }, 2600);
        }

        function renderSkeleton() {
            closeActiveSwipe();
            const skeleton = Array.from({ length: 3 }).map(() => `
                <div class="skeleton-card">
                    <div class="skeleton-block" style="width: 120px; height: 16px;"></div>
                    <div class="skeleton-block" style="width: 70%; height: 20px; margin-top: 14px;"></div>
                    <div class="skeleton-row">
                        <div class="skeleton-block" style="flex:1; height: 14px;"></div>
                        <div class="skeleton-block" style="flex:1; height: 14px;"></div>
                    </div>
                    <div class="skeleton-row">
                        <div class="skeleton-block" style="width: 40%; height: 14px;"></div>
                        <div class="skeleton-block" style="width: 28%; height: 14px;"></div>
                        <div class="skeleton-block" style="width: 20%; height: 14px;"></div>
                    </div>
                    <div class="skeleton-block" style="width: 100%; height: 44px; margin-top: 20px;"></div>
                </div>
            `).join('');
            ordersContainer.innerHTML = skeleton;
        }

        function closeActiveSwipe() {
            if (activeSwipe?.close) {
                activeSwipe.close();
            }
            activeSwipe = null;
        }

        function attachSwipeHandlers(actions) {
            const primaryBtn = actions.querySelector('.primary-btn');
            const complaintBtn = actions.querySelector('.complain-btn');
            if (!primaryBtn || !complaintBtn) {
                return;
            }
            primaryBtn.dataset.blockClick = primaryBtn.dataset.blockClick || '0';

            const maxReveal = Math.min(Math.max(complaintBtn.getBoundingClientRect().width || 150, 120), 220);
            let revealed = false;
            let startX = 0;
            let baseOffset = 0;
            let currentOffset = 0;
            let dragging = false;
            let hasMoved = false;

            const applyOffset = (offset) => {
                currentOffset = offset;
                primaryBtn.style.transform = `translateX(${offset}px)`;
            };

            const setReveal = (value) => {
                revealed = value;
                actions.classList.toggle('revealed', value);
                const targetOffset = value ? -maxReveal : 0;
                applyOffset(targetOffset);
                baseOffset = targetOffset;

                if (value) {
                    if (activeSwipe && activeSwipe.el !== actions) {
                        activeSwipe.close();
                    }
                    activeSwipe = {
                        el: actions,
                        close: () => {
                            actions.classList.remove('revealed');
                            applyOffset(0);
                            baseOffset = 0;
                            revealed = false;
                            primaryBtn.classList.remove('swipe-active');
                        }
                    };
                } else if (activeSwipe && activeSwipe.el === actions) {
                    activeSwipe = null;
                }
            };

            const finishSwipe = () => {
                dragging = false;
                primaryBtn.classList.remove('swipe-active');
                const threshold = Math.min(maxReveal * 0.6, 110);
                if (-currentOffset >= threshold) {
                    setReveal(true);
                } else {
                    setReveal(false);
                }
                if (hasMoved) {
                    primaryBtn.dataset.blockClick = '1';
                    requestAnimationFrame(() => {
                        primaryBtn.dataset.blockClick = '0';
                    });
                }
            };

            primaryBtn.addEventListener('pointerdown', (event) => {
                if (event.pointerType === 'mouse' && event.button !== 0) {
                    return;
                }
                dragging = true;
                hasMoved = false;
                startX = event.clientX;
                baseOffset = revealed ? -maxReveal : 0;
                primaryBtn.classList.add('swipe-active');
                try {
                    primaryBtn.setPointerCapture(event.pointerId);
                } catch (err) {
                    // ignore unsupported pointer capture
                }
                if (activeSwipe && activeSwipe.el !== actions) {
                    activeSwipe.close();
                }
            });

            primaryBtn.addEventListener('pointermove', (event) => {
                if (!dragging) {
                    return;
                }
                const delta = event.clientX - startX;
                if (!hasMoved && Math.abs(delta) > 4) {
                    hasMoved = true;
                }
                let offset = baseOffset + delta;
                if (offset > 0) {
                    offset = 0;
                }
                if (offset < -maxReveal) {
                    offset = -maxReveal;
                }
                applyOffset(offset);
            });

            const pointerUpHandler = (event) => {
                if (!dragging) {
                    return;
                }
                try {
                    primaryBtn.releasePointerCapture(event.pointerId);
                } catch (err) {
                    // ignore
                }
                finishSwipe();
            };

            primaryBtn.addEventListener('pointerup', pointerUpHandler);
            primaryBtn.addEventListener('pointercancel', pointerUpHandler);

            complaintBtn.addEventListener('click', (event) => {
                event.preventDefault();
                closeActiveSwipe();
                openComplaint(actions.dataset.order);
            });

            primaryBtn.addEventListener('click', (event) => {
                if (primaryBtn.dataset.blockClick === '1') {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    return;
                }
                closeActiveSwipe();
                openConfirm(actions.dataset.order);
            });
        }

        function initializeSwipeActions() {
            const wrappers = ordersContainer.querySelectorAll('.swipe-actions');
            wrappers.forEach(actions => {
                if (actions.dataset.bound === 'true') {
                    return;
                }
                actions.dataset.bound = 'true';
                attachSwipeHandlers(actions);
            });
        }

        function runHighlightAnimation() {
            if (!highlightTitle) {
                return;
            }
            highlightTitle.classList.add('orders-section-title--pulse');
            highlightFlame?.classList.add('orders-section-title__flame--active');
            clearTimeout(highlightTimer);
            highlightTimer = setTimeout(() => {
                highlightTitle.classList.remove('orders-section-title--pulse');
                highlightFlame?.classList.remove('orders-section-title__flame--active');
            }, 4000);
        }

        function triggerHighlightIfNeeded() {
            if (highlightPlayed || !refreshBtn || !highlightTitle) {
                return;
            }
            const rect = refreshBtn.getBoundingClientRect();
            if (rect.bottom <= 0) {
                highlightPlayed = true;
                runHighlightAnimation();
                window.removeEventListener('scroll', handleHighlightScroll);
            }
        }

        function handleHighlightScroll() {
            triggerHighlightIfNeeded();
        }

        function setupHighlightObserver() {
            if (!refreshBtn || !highlightTitle) {
                return;
            }
            window.addEventListener('scroll', handleHighlightScroll, { passive: true });
            setTimeout(() => triggerHighlightIfNeeded(), 600);
        }

        function toggleCollapsible(valueEl, innerEl, expand) {
            const expanded = expand ?? valueEl.dataset.expanded !== 'true';
            valueEl.dataset.expanded = expanded ? 'true' : 'false';
            valueEl.classList.toggle('is-expanded', expanded);
            const targetHeight = expanded ? innerEl.scrollHeight + 24 : COLLAPSIBLE_COLLAPSED_HEIGHT;
            valueEl.style.maxHeight = `${targetHeight}px`;
            if (!expanded) {
                valueEl.scrollTop = 0;
            }
        }

        function initializeCollapsibleFields() {
            const values = ordersContainer.querySelectorAll('.order-field__value--collapsible');
            values.forEach(valueEl => {
                const innerEl = valueEl.querySelector('.order-field__inner');
                if (!innerEl) {
                    return;
                }

                const needsCollapse = innerEl.scrollHeight > COLLAPSIBLE_COLLAPSED_HEIGHT + 8;
                if (needsCollapse) {
                    valueEl.classList.add('is-collapsible');
                    if (valueEl.dataset.bound !== 'true') {
                        valueEl.addEventListener('click', event => {
                            if (!valueEl.classList.contains('is-collapsible')) {
                                return;
                            }
                            event.preventDefault();
                            closeActiveSwipe();
                            tg?.HapticFeedback?.selectionChanged?.();
                            toggleCollapsible(valueEl, innerEl);
                        });
                        valueEl.dataset.bound = 'true';
                    }
                    if (valueEl.dataset.expanded === 'true') {
                        toggleCollapsible(valueEl, innerEl, true);
                    } else {
                        valueEl.dataset.expanded = 'false';
                        valueEl.classList.remove('is-expanded');
                        valueEl.style.maxHeight = `${COLLAPSIBLE_COLLAPSED_HEIGHT}px`;
                    }
                } else {
                    valueEl.classList.remove('is-collapsible');
                    valueEl.classList.add('is-expanded');
                    valueEl.dataset.expanded = 'true';
                    valueEl.style.maxHeight = `${innerEl.scrollHeight}px`;
                }
            });
        }

        function refreshCollapsibleHeights() {
            const values = ordersContainer.querySelectorAll('.order-field__value--collapsible');
            values.forEach(valueEl => {
                const innerEl = valueEl.querySelector('.order-field__inner');
                if (!innerEl) {
                    return;
                }
                if (!valueEl.classList.contains('is-collapsible')) {
                    valueEl.style.maxHeight = `${innerEl.scrollHeight}px`;
                } else if (valueEl.dataset.expanded === 'true') {
                    valueEl.style.maxHeight = `${innerEl.scrollHeight + 24}px`;
                } else {
                    valueEl.style.maxHeight = `${COLLAPSIBLE_COLLAPSED_HEIGHT}px`;
                }
            });
        }

        window.addEventListener('resize', () => {
            clearTimeout(collapsibleResizeTimer);
            collapsibleResizeTimer = setTimeout(() => {
                refreshCollapsibleHeights();
            }, 180);
        });

        function setSort(direction) {
            if (sortDirection === direction) return;
            sortDirection = direction;
            document.getElementById('sortCheap').classList.toggle('active', direction === 'asc');
            document.getElementById('sortExpensive').classList.toggle('active', direction === 'desc');
            renderOrders();
        }

        function splitScheduleInfo(raw) {
            if (!raw) {
                return { when: '', time: '' };
            }

            const cleaned = raw.toString().replace(/\s+/g, ' ').trim();
            if (!cleaned) {
                return { when: '', time: '' };
            }

            const ranges = [];
            const rangePattern = /(—Å|c)?\s*(\d{1,2})[:.\-](\d{2})\s*(?:–¥–æ|–ø–æ|[-‚Äì‚Äî])\s*(\d{1,2})[:.\-](\d{2})/gi;
            const rangeMatches = [...cleaned.matchAll(rangePattern)];
            let rest = cleaned;

            if (rangeMatches.length) {
                for (const match of rangeMatches) {
                    const startHour = match[2].padStart(2, '0');
                    const startMinute = match[3];
                    const endHour = match[4].padStart(2, '0');
                    const endMinute = match[5];
                    ranges.push(`${startHour}:${startMinute} ‚Äî ${endHour}:${endMinute}`);
                }
                rest = rest.replace(rangePattern, ' ').replace(/\s+/g, ' ').trim();
            } else {
                const singlePattern = /\b\d{1,2}[:.\-]\d{2}\b/g;
                const singles = cleaned.match(singlePattern);
                if (singles) {
                    const normalizedSingles = singles.map(token => {
                        const [hours, minutes] = token.split(/[:.\-]/);
                        return `${hours.padStart(2, '0')}:${minutes}`;
                    });
                    if (normalizedSingles.length === 1) {
                        ranges.push(normalizedSingles[0]);
                    } else if (normalizedSingles.length >= 2) {
                        ranges.push(`${normalizedSingles[0]} ‚Äî ${normalizedSingles[1]}`);
                    }
                    rest = rest.replace(singlePattern, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            let when = '';
            if (rest) {
                const parts = rest
                    .split(/[,.;\n]/)
                    .map(part => part.trim())
                    .filter(Boolean);

                for (const part of parts) {
                    const lower = part.toLowerCase();
                    if (/(—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞|–Ω–æ—á|—É—Ç—Ä|–¥–µ–Ω—å|–≤–µ—á–µ—Ä|–±—É–¥–Ω|–≤—ã—Ö–æ–¥–Ω|–ø–æ–Ω–µ–¥|–≤—Ç–æ—Ä|—Å—Ä–µ–¥|—á–µ—Ç–≤|–ø—è—Ç–Ω|—Å—É–±–±|–≤–æ—Å–∫—Ä|–Ω–∞\s)/.test(lower)) {
                        when = part;
                        break;
                    }
                }

                if (!when && parts.length) {
                    when = parts[0];
                }
            }

            if (when) {
                when = when
                    .replace(/\b\d+\s*(?:—á–µ–ª|—á–µ–ª–æ–≤–µ–∫|–ª—é–¥–µ–π|–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª[—å—è–µ–π]?|—Å–º–µ–Ω|—Ä–∞–±–æ—Ç–Ω–∏–∫(?:–æ–≤)?|–ø–µ—Ä—Å–æ–Ω–∞–ª–∞)\b/gi, '')
                    .replace(/^(–∏|–∞)\s+/i, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
            }

            const time = ranges.join(', ').trim();

            return { when, time };
        }

        function capitalizeFirst(value) {
            if (!value) return value;
            return value.charAt(0).toUpperCase() + value.slice(1);
        }

        function formatAddressField(order) {
            const address = order.address?.toString().trim();
            if (address) {
                return address;
            }
            return '–ê–¥—Ä–µ—Å —É—Ç–æ—á–Ω—è–µ—Ç—Å—è';
        }

        function formatTimeValue(order, schedule) {
            if (schedule?.time) {
                return schedule.time;
            }
            const raw = order.start_time?.toString().trim();
            if (!raw) {
                return '';
            }
            const match = raw.match(/\b\d{1,2}[:.]\d{2}\b/);
            if (!match) {
                return '';
            }
            const [hours, minutes] = match[0].split(/[:.]/);
            return `${hours.padStart(2, '0')}:${minutes}`;
        }

        function formatDescriptionField(order) {
            const blocks = [];
            const comment = order.comment?.toString().trim();
            if (comment) {
                blocks.push(comment);
            }

            const extraDetails = [];
            if (order.workers_count) {
                extraDetails.push(`–ù—É–∂–Ω–æ: ${order.workers_count} —á–µ–ª.`);
            }
            if (order.phone_number) {
                extraDetails.push(`–ö–æ–Ω—Ç–∞–∫—Ç: ${order.phone_number}`);
            }
            if (extraDetails.length) {
                blocks.push(extraDetails.join(' ¬∑ '));
            }

            if (blocks.length) {
                return blocks.join('\n');
            }

            return '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
        }

        function formatRelative(isoDate) {
            if (!isoDate) return '–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–µ–¥–∞–≤–Ω–æ';
            const created = new Date(isoDate);
            const now = new Date();
            const diffMs = now - created;
            const diffMinutes = Math.floor(diffMs / 60000);
            if (diffMinutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMinutes < 60) return `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        }

        function updateMetrics(orders) {
            if (!orders?.length) {
                metricAvailable.textContent = '0';
                metricAvg.textContent = '‚Äî ‚ÇΩ';
                return;
            }
            const total = orders.length;
            const avgPrice = Math.round(orders.reduce((sum, order) => sum + (order.price || 0), 0) / total);
            metricAvailable.textContent = total;
            metricAvg.textContent = `${avgPrice.toLocaleString('ru-RU')} ‚ÇΩ`;
        }

        function renderEmptyState(message, sub) {
            ordersContainer.innerHTML = `
                <div class="state-placeholder">
                    <h3>${message}</h3>
                    <p>${sub}</p>
                </div>
            `;
        }

        function renderOrders() {
            closeActiveSwipe();
            if (!ordersCache.length) {
                renderEmptyState('–°–µ–π—á–∞—Å –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç', '–ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –ª–µ–Ω—Ç—É —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç.');
                return;
            }

            const sorted = [...ordersCache].sort((a, b) => {
                const priceA = a.price || 0;
                const priceB = b.price || 0;
                return sortDirection === 'asc' ? priceA - priceB : priceB - priceA;
            });

            ordersContainer.innerHTML = sorted.map(order => {
                const price = Number(order.price || 0).toLocaleString('ru-RU');
                const created = formatRelative(order.created_at);
                const ratingValue = Number(order.customer_rating);
                const rating = Number.isFinite(ratingValue) ? ratingValue.toFixed(1) : '4.9';
                const customer = order.customer_name || order.customer_username || '–ó–∞–∫–∞–∑—á–∏–∫';
                const schedule = splitScheduleInfo(order.start_time);
                const addressValue = formatAddressField(order);
                const descriptionValue = formatDescriptionField(order);
                const timeValue = formatTimeValue(order, schedule);
                const whenNote = schedule.when ? capitalizeFirst(schedule.when) : '';
                const addressCombined = timeValue ? `${addressValue} <span class="order-field__time">| ${timeValue}</span>` : addressValue;
                const chips = [];

                if (order.phone_number) {
                    chips.push(`<span class="chip">‚òé ${order.phone_number}</span>`);
                }

                return `
                    <article class="order-card">
                        <div class="order-card__head">
                            <div>
                                <span class="order-id">–ó–∞–∫–∞–∑ #${order.order_id || '‚Äî'}</span>
                                <div class="hero-caption" style="margin-top:6px;">${created}</div>
                            </div>
                            <div class="order-price">
                                <span class="price-amount">${price} ‚ÇΩ</span>
                                <span class="price-hint">–∑–∞ —Å–º–µ–Ω—É</span>
                            </div>
                        </div>
                        <div class="order-fields">
                            <div class="order-field order-field--address">
                                <div class="order-field__label">–ê–¥—Ä–µ—Å –∏ –≤—Ä–µ–º—è</div>
                                <div class="order-field__value">
                                    <span class="order-field__inline">${addressCombined}</span>
                                    ${whenNote ? `<div class="order-field__note">${whenNote}</div>` : ''}
                                </div>
                            </div>
                            <div class="order-field order-field--description">
                                <div class="order-field__label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                                <div class="order-field__value order-field__value--collapsible" data-expanded="false">
                                    <div class="order-field__inner">${descriptionValue}</div>
                                    <div class="order-field__fade"></div>
                                </div>
                            </div>
                        </div>
                        <div class="order-stats">
                            <div class="order-stats__item">
                                <span class="order-stats__label">–ó–∞–∫–∞–∑—á–∏–∫</span>
                                <span class="order-stats__value">
                                    üë§ ${customer}
                                    <span class="order-stats__rating">‚≠ê ${rating}</span>
                                </span>
                            </div>
                        </div>
                        ${chips.length ? `<div class="chip-row">${chips.join('')}</div>` : ''}
                        <div class="order-footer">
                            <div class="swipe-actions" data-order="${order.order_id || ''}">
                                <button class="complain-btn" type="button" data-order="${order.order_id || ''}"><span>‚ö† –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</span></button>
                                <button class="primary-btn" type="button" data-order="${order.order_id || ''}">
                                    <span class="primary-btn__label">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</span>
                                    <span class="primary-btn__hint">—Å–≤–∞–π–ø ‚Üê</span>
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            initializeSwipeActions();
            initializeCollapsibleFields();
            refreshCollapsibleHeights();
        }

        async function loadOrders(manual = false) {
            try {
                if (manual) {
                    tg?.HapticFeedback?.impactOccurred?.('medium');
                }

                renderSkeleton();

                const query = userId ? `?user_id=${userId}` : '';
                const response = await fetch(`/api/orders${query}`);
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                const data = await response.json();

                if (!data?.success || !Array.isArray(data.orders)) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }

                ordersCache = data.orders || [];
                updateMetrics(ordersCache);
                renderOrders();
                if (manual) {
                    showToast('–õ–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                }
            } catch (error) {
                renderEmptyState('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑.');
                metricAvailable.textContent = '0';
                metricAvg.textContent = '‚Äî ‚ÇΩ';
                console.error(error);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ª–µ–Ω—Ç—É', 'error');
            }
        }

        function openConfirm(orderId) {
            closeActiveSwipe();
            const trimmedId = orderId?.toString().trim();
            if (!trimmedId) {
                console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞');
                return;
            }
            pendingOrderId = trimmedId;
            document.getElementById('confirmText').textContent = `–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –∑–∞–∫–∞–∑ #${trimmedId}?`;
            confirmOverlay?.classList.add('visible');
            tg?.HapticFeedback?.impactOccurred?.('soft');
        }

        function hideConfirm() {
            pendingOrderId = null;
            confirmOverlay?.classList.remove('visible');
        }

        function confirmAccept() {
            if (!pendingOrderId) return;
            tg?.HapticFeedback?.impactOccurred?.('heavy');
            tg?.sendData?.(JSON.stringify({ action: 'accept_order', order_id: pendingOrderId }));
            hideConfirm();
            showToast('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–∫–∞–∑—á–∏–∫—É', 'success');
        }

        function openComplaint(orderId) {
            closeActiveSwipe();
            const trimmedId = orderId?.toString().trim();
            if (!trimmedId) {
                console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –∂–∞–ª–æ–±—ã');
                return;
            }
            complaintOrderId = trimmedId;
            const order = ordersCache.find(item => item?.order_id?.toString() === trimmedId);
            const title = order?.work_type || '–°–º–µ–Ω–∞ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const labelParts = [`–ó–∞–∫–∞–∑ #${order?.order_id || trimmedId}`];
            if (title) {
                labelParts.push(title);
            }
            complaintOrderInfo.textContent = labelParts.join(' ¬∑ ');
            complaintTextarea.value = '';
            complaintOverlay?.classList.add('visible');
            tg?.HapticFeedback?.impactOccurred?.('light');
            setTimeout(() => {
                try {
                    complaintTextarea?.focus({ preventScroll: true });
                } catch (err) {
                    complaintTextarea?.focus();
                }
            }, 120);
        }

        function hideComplaint() {
            complaintOrderId = null;
            complaintTextarea.value = '';
            complaintOverlay?.classList.remove('visible');
            closeActiveSwipe();
        }

        async function submitComplaint() {
            if (!complaintOverlay?.classList.contains('visible') || !complaintOrderId || isSubmittingComplaint) {
                return;
            }

            const description = complaintTextarea.value.trim();
            if (description.length < 4) {
                showToast('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ', 'error');
                complaintTextarea.focus();
                return;
            }

            isSubmittingComplaint = true;
            try {
                tg?.HapticFeedback?.impactOccurred?.('medium');
                const payload = {
                    order_id: Number(complaintOrderId) || complaintOrderId,
                    category: 'miniapp',
                    description
                };
                if (userId) {
                    payload.user_id = userId;
                }

                const response = await fetch('/api/complaint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data?.success) {
                    throw new Error(data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É');
                }

                showToast('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É', 'success');
                tg?.HapticFeedback?.notificationOccurred?.('success');
                hideComplaint();
            } catch (error) {
                console.error(error);
                showToast(error?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∂–∞–ª–æ–±—ã', 'error');
                tg?.HapticFeedback?.notificationOccurred?.('error');
            } finally {
                isSubmittingComplaint = false;
            }
        }

        complaintOverlay?.addEventListener('click', (event) => {
            if (event.target === complaintOverlay) {
                hideComplaint();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (complaintOverlay?.classList.contains('visible')) {
                    hideComplaint();
                } else if (confirmOverlay?.classList.contains('visible')) {
                    hideConfirm();
                } else {
                    closeActiveSwipe();
                }
            }
        });

        setupHighlightObserver();
        loadOrders();
    </script>
</body>
</html>
